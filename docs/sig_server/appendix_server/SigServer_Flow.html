<html>

<head>
<meta http-equiv="Content-Type" content="text/html; charset=shift_jis">
<link rel="stylesheet" type="text/css" href="../../prj.css"/>
<title>主要な処理の流れ</title>
</head>

<body>

<h1>主要な処理の流れ</h1>
<ul>
  <li><a href="#startsim">シミュレータの起動からシミュレーションの開始</a></li>
  <li><a href="#controller_provider">コントローラとサービスプロバイダーの連携</a></li>
  <li><a href="#c_to_c">コントローラ間の通信</a></li>
</ul>

<h2><a name="startsim">シミュレータの起動からシミュレーションの開始</a></h2>

<table>
  <tr valign="top">
	<td><a href="sim_start_pic.png"><img src="sim_start_pic.png" width="370" height="350"/></a></td>
	<td>
	  <p>シミュレーションサーバは起動後世界ファイルを読み込む。世界ファイルで、エージェントに対してコントローラが割り当てられている場合、子プロセスとしてコントローラ(sigrunacコマンド)を起動する(1)。sigruacコマンドは、シェアードライブラリとして実装されたコントローラを動的にロードし、シミュレーションサーバに対してコマンドポートとデータポートの２つのコネクションを張る(1.1, 1.2)。</p>
	  <p>
	  コマンドポートはサーバから転送されるコントローライベント呼び出しの待ち受けに用いられ、sigrunacプロセスがそれらを受信するとそれに応じたコントローラのイベントハンドラ(onAction, onRecvTextなど)を呼び出す。データポートはコントローラのイベントハンドラにおける処理で、必要に応じてシミュレーションサーバにデータ取得などリクエストの送信・結果の受信を行う際に用いられる。</p>

	  <p>
	  コントローラが起動されシミュレーションの準備が整ったあと、ビューアからのシミュレーション開始メッセージ(2)によりシミュレーションが開始される。シミュレーション開始直後、すべてのコントローラに対してonInitメソッドの呼び出しが行われ(2.1)、コントローラを初期化する。その後シミュレーションステップが進む毎に、コントローラの対してonActionメソッドを呼び出す(2.2)。
	  </p>
	  <p>
	  ビューアは逐一シミュレーションサーバに対して、データ取得リクエストを送信してすべてのエンティティの状態を取得し(3)、その結果を描画する(4)。
	  </p>
	  <p>シミュレーションサーバは、プロセス終了にコントローラプロセスを終了させる(5)。</p>
	</td></tr>
</table>


<h2><a name="controller_provider">コントローラとサービスプロバイダーの連携</a></h2>
<table>
  <tr valign="top">
	<td><a href="service_provider_pic.png"><img src="service_provider_pic.png" width="370" height="350"/></a></td>
	<td>
	  <p>通常コントローラは、シミュレーションサーバの機能の支援を受けてエージェ
	 ントの制御を行う。しかしながら、エージェント視点でのシミュレーショ
	 ン世界内の画像キャプチャなど、一部の機能はシミュレーションサーバで
	 は実現できない。サービスプロバイダは、シミュレーションサーバでは実
	 現できない機能を、同じまたは異なるマシン上の別のプロセスで、代わりに提供するための仕組みである。</p>
	  <p>サービスプロバイダは、起動時にシミュレーションサーバに接続し、
	 サービスを提供するホスト名、ポート番号、提供するサービスのタイプを
	 登録する(1)。コントローラは、サービスプロバイダによる機能を使用する
	 にあたり、シミュレーションサーバのネームサービス機能を使ってサービ
	 スプロバイダ情報の問い合わせを行う(2)。シミュレーションサーバは、コ
	 ントローラからの問い合わせを受けると、登録されているサービスが使用
	 可能であるかをpingで確認(2.1)してから、コントローラにサービスプロバ
	 イダ情報を送る。コントローラは、その情報に基づいてサービスプロバイダとコネクションを張り、サービスを受ける。コントローラは、サービスプロバイダのサービスを使用するたびにコネクションを張り、結果を取得したあとはクローズする。</p>
	</td>
</table>

<h2><a name="c_to_c">コントローラ間の通信</a></h2>

<table>
  <tr valign="top">
	<td><a href="data_forward_pic.png"><img src="data_forward_pic.png" width="370" height="250"/></a></td>
	<td>
	<td>
	  <p>テキスト、音声、メッセージなど送信先を指定したコントローラ間のデータ通信は、
  シミュレーションサーバを介して行う。これを実現するため、シミュレーショ
  ンサーバでは、エージェント名とそれを制御するコントローラの対応関係を
  保持している。送信先を指定しないと、送信元のエージェントを除くすべて
  の エージェントに対して転送される。
  </p>
	  <p>

	  コントローラから、シミュレーションサーバに対して、送信先エージェ
	  ントの名前を加えて転送データを送信する(1)。シミュレーションサー
	  バは、送信先コントローラを見つけ、データをそのまま転送する。
	  </p>
	</td>
  </tr>
</table>

<hr><address style="align: right;"><a href="http://www.msi.co.jp"><img src="msilogo.gif" align="middle" border=0

width=139 height=53>（株）数理システム</a>
</body>

</html>
